name: Deploy AI Constructor Manager

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    environment:
      name: 'Production'
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies and build package
        run: |
          # Install Python dependencies
          pip install -r requirements.txt
          
          # Create wwwroot directory for Azure App Service
          mkdir -p wwwroot
          
          # Copy backend files to root (FastAPI needs to be at root level)
          cp -r backend/* .
          
          # Copy frontend files to wwwroot for static serving
          cp -r frontend/* wwwroot/
          
          # Update frontend API configuration for production
          sed -i "s|const API_BASE = 'http://localhost:8000'|const API_BASE = window.location.origin|g" wwwroot/app.js
          
          # Create startup script for Azure
          cat > startup.sh << 'EOF'
          #!/bin/bash
          cd /home/site/wwwroot
          python -m gunicorn app.main:app --bind 0.0.0.0:8000 --worker-class uvicorn.workers.UvicornWorker
          EOF
          chmod +x startup.sh
          
          # Create web.config for static file serving
          cat > web.config << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <configuration>
            <system.webServer>
              <handlers>
                <add name="PythonHandler" path="*" verb="*" modules="FastCgiModule" scriptProcessor="D:\home\Python311\python.exe|D:\home\site\wwwroot\app\main.py" resourceType="Unspecified" requireAccess="Script"/>
              </handlers>
              <staticContent>
                <mimeMap fileExtension=".js" mimeType="application/javascript" />
                <mimeMap fileExtension=".css" mimeType="text/css" />
                <mimeMap fileExtension=".json" mimeType="application/json" />
              </staticContent>
              <rewrite>
                <rules>
                  <rule name="API Routes" stopProcessing="true">
                    <match url="^api/.*|^health|^projects|^bills.*|^upload_.*|^bill/.*" />
                    <action type="None" />
                  </rule>
                  <rule name="Static Files" stopProcessing="true">
                    <match url=".*\.(js|css|html|png|jpg|gif|ico)$" />
                    <action type="Rewrite" url="wwwroot/{R:0}" />
                  </rule>
                  <rule name="Frontend Routes" stopProcessing="true">
                    <match url=".*" />
                    <action type="Rewrite" url="wwwroot/index.html" />
                  </rule>
                </rules>
              </rewrite>
            </system.webServer>
          </configuration>
          EOF

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_F2B4E34B36464EC89A5CB7BFC369E33C }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_6CF628C51CDC437988CBF0D67E684EC5 }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_67D3F163AA98458BAF8D18B71B37AD46 }}

      - name: Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'AiConstruction'
          slot-name: 'Production'
          package: .
